@model SistemaDeCotizacion.ViewModels.CotizacionVM
@{
    ViewData["Title"] = "Editar Cotización";
    Layout = "_Layout";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow border-0">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">Editar Cotización</h4>
                </div>
                <div class="card-body bg-light">
                    @if (ViewData["mensaje"] != null)
                    {
                        <div class="alert alert-danger text-center">@ViewData["mensaje"]</div>
                    }

                    <form asp-action="Editar" method="post">
                        <input asp-for="CotizacionId" type="hidden" />
                        <div class="mb-3">
                            <label>Cliente</label>
                            <select id="clienteSelect" asp-for="ClienteId" class="form-select">
                                <option value="">-- Seleccione un cliente --</option>
                            </select>
                        </div>

                        <div class="mb-3"> 
                            <label>Vehículo</label> 
                            <select id="vehiculoSelect" asp-for="VehiculoId" class="form-select"> 
                                <option value="">-- Seleccione un vehículo --</option> 
                                @foreach (var v in Model.Vehiculos) 
                                { 
                                    if (v.vehiculo_id == Model.VehiculoId) 
                                    {
                                        <option value="@v.vehiculo_id" selected> @v.placa (@v.marca - @v.modelo) </option>
                                    }
                                    else
                                    {
                                    <option value="@v.vehiculo_id"> @v.placa (@v.marca - @v.modelo) </option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Servicios</label>
                            <div id="serviciosContainer">
                                @if (Model.ServiciosSeleccionados.Any())
                                {
                                    @for (int i = 0; i < Model.ServiciosSeleccionados.Count; i++)
                                    {
                                        var seleccionado = Model.ServiciosSeleccionados[i];
                                        <div class="d-flex align-items-center mb-2 servicio-row">
                                            <select name="ServiciosSeleccionados[@i].ServicioId" class="form-select me-2 servicioSelect" style="flex: 2">
                                                <option value="">-- Seleccione un servicio --</option>
                                                @foreach (var s in Model.Servicios)
                                                {
                                                    <option value="@s.servicio_id" selected="@(seleccionado.ServicioId == s.servicio_id ? "selected" : null)">
                                                        #@s.nombre_servicio - S/. @s.precio
                                                    </option>
                                                }
                                            </select>
                                            <button type="button" class="btn btn-outline-secondary ms-2 agregarServicio">+</button>
                                            <button type="button" class="btn btn-outline-danger ms-2 eliminarFila">🗑</button>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="d-flex align-items-center mb-2 servicio-row">
                                        <select name="ServiciosSeleccionados[0].ServicioId" class="form-select me-2 servicioSelect" style="flex: 2">
                                            <option value="">-- Seleccione un servicio --</option>
                                            @foreach (var s in Model.Servicios)
                                            {
                                                <option value="@s.servicio_id">@s.nombre_servicio - S/. @s.precio</option>
                                            }
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary ms-2 agregarServicio">+</button>
                                        <button type="button" class="btn btn-outline-danger ms-2 eliminarFila">🗑</button>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="mb-3">
                            <label>Repuestos</label>
                            <div id="repuestosContainer">
                                @if (Model.RepuestosSeleccionados.Any())
                                {
                                    @for (int i = 0; i < Model.RepuestosSeleccionados.Count; i++)
                                    {
                                        var rep = Model.RepuestosSeleccionados[i];
                                        <div class="d-flex align-items-center mb-2 repuesto-row">
                                            <select name="RepuestosSeleccionados[@i].RepuestoId" class="form-select me-2 repuestoSelect" style="flex: 2">
                                                <option value="">-- Seleccione un repuesto --</option>
                                                @foreach (var r in Model.Repuestos)
                                                {
                                                    <option value="@r.repuesto_id" selected="@(rep.RepuestoId == r.repuesto_id ? "selected" : null)">
                                                        #@r.descripcion (Stock: @r.stock)
                                                    </option>
                                                }
                                            </select>
                                            <input name="RepuestosSeleccionados[@i].Cantidad" type="number" class="form-control" style="width:100px" min="1" value="@rep.Cantidad" placeholder="Cant." />
                                            <button type="button" class="btn btn-outline-secondary ms-2 agregarRepuesto">+</button>
                                            <button type="button" class="btn btn-outline-danger ms-2 eliminarFila">🗑</button>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="d-flex align-items-center mb-2 repuesto-row">
                                        <select name="RepuestosSeleccionados[0].RepuestoId" class="form-select me-2 repuestoSelect" style="flex: 2">
                                            <option value="">-- Seleccione un repuesto --</option>
                                            @foreach (var r in Model.Repuestos)
                                            {
                                                <option value="@r.repuesto_id">@r.descripcion (Stock: @r.stock)</option>
                                            }
                                        </select>
                                        <input name="RepuestosSeleccionados[0].Cantidad" type="number" class="form-control" style="width:100px" min="1" placeholder="Cant." />
                                        <button type="button" class="btn btn-outline-secondary ms-2 agregarRepuesto">+</button>
                                        <button type="button" class="btn btn-outline-danger ms-2 eliminarFila">🗑</button>
                                    </div>
                                }
                            </div>
                        </div>


                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="formaPago" class="form-label">Forma de Pago</label>
                                <input asp-for="formaPago" class="form-control" placeholder="Efectivo, transferencia..." required />
                            </div>
                            <div class="col-md-6">
                                <label asp-for="tiempoEntrega" class="form-label">Tiempo de entrega (días)</label>
                                <input asp-for="tiempoEntrega" type="number" class="form-control" required />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label>Estado</label>
                            <select asp-for="estado_cotizacion" class="form-select">
                                <option value="Pendiente">Pendiente</option>
                                <option value="Aprobado">Aprobado</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a asp-action="Mostrar" class="btn btn-outline-dark">Volver</a>
                            <button type="submit" class="btn btn-dark">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        // Prepara los servicios seleccionados para que Select2 los muestre aunque use AJAX
        var serviciosPreList = Model.ServiciosSeleccionados
            .Select((s, idx) =>
            {
                var serv = Model.Servicios.FirstOrDefault(x => x.servicio_id == s.ServicioId);
                var texto = serv != null ? ("#" + serv.nombre_servicio + " - S/. " + serv.precio) : "";
                return new { index = idx, id = s.ServicioId, text = texto };
            })
            .ToList();
        var serviciosPreJson = System.Text.Json.JsonSerializer.Serialize(serviciosPreList);

        // Prepara los repuestos seleccionados para que Select2 los muestre aunque use AJAX
        var repuestosPreList = Model.RepuestosSeleccionados
            .Select((r, idx) =>
            {
                var rep = Model.Repuestos.FirstOrDefault(x => x.repuesto_id == r.RepuestoId);
                var texto = rep != null ? ("#" + rep.descripcion + " (Stock: " + rep.stock + ")") : "";
                return new { index = idx, id = r.RepuestoId, text = texto, cantidad = r.Cantidad };
            })
            .ToList();
        var repuestosPreJson = System.Text.Json.JsonSerializer.Serialize(repuestosPreList);
    }

    <script>

        $(document).ready(function () {
            function inicializarSelect2Servicios() {
                $('.servicioSelect').select2({
                    placeholder: "-- Seleccione un servicio --",
                    allowClear: true,
                    ajax: {
                        url: '/Cotizacion/BuscarServicios',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            return { term: params.term };
                        },
                        processResults: function (data) {
                            return {
                                results: data
                            };
                        }
                    }
                });
            }

            // Inicializar en la carga inicial
            inicializarSelect2Servicios();

            // Preseleccionar los servicios ya asociados a la cotización (si existen)
            var serviciosPreseleccionados = @Html.Raw(serviciosPreJson ?? "[]");
            serviciosPreseleccionados.forEach(function (s) {
                var selEl = $('select[name="ServiciosSeleccionados[' + s.index + '].ServicioId"]');
                if (!selEl.length) return;
                // Si la opción no existe en el select la añadimos y la marcamos seleccionada
                if (selEl.find('option[value="' + s.id + '"]').length === 0) {
                    var option = new Option(s.text, s.id, true, true);
                    selEl.append(option);
                }
                selEl.val(s.id).trigger('change');
            });

            // Al agregar nueva fila de servicio
            $(document).on('click', '.agregarServicio', function () {
                const container = $('#serviciosContainer');
                const rows = container.find('.servicio-row');
                const newIndex = rows.length;

                const nuevaFila = rows.first().clone();

                // Actualizar nombres e IDs
                nuevaFila.find('select')
                    .attr('name', `ServiciosSeleccionados[${newIndex}].ServicioId`)
                    .val(null)
                    .off('select2') // Evita conflicto
                    .removeAttr('data-select2-id')
                    .removeClass('select2-hidden-accessible')
                    .next('.select2').remove();

                container.append(nuevaFila);

                // Re-inicializar Select2 en la nueva fila
                inicializarSelect2Servicios();
            });

            // Eliminar fila de servicio
            $(document).on('click', '.eliminarFila', function () {
                const row = $(this).closest('.servicio-row');
                if ($('#serviciosContainer .servicio-row').length > 1) {
                    row.remove();
                }
            });
        });

        $(document).ready(function () {
            // Inicializar Select2 para cliente con AJAX
            $('#clienteSelect').select2({
                placeholder: "-- Seleccione un cliente --",
                allowClear: true,
                ajax: {
                    url: '/Cotizacion/BuscarClientes',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return { term: params.term };
                    },
                    processResults: function (data) {
                        return {
                            results: data.map(c => ({
                                id: c.id,
                                text: c.text
                            }))
                        };
                    }
                }
            });

            const clienteId = '@ViewBag.ClienteId';
            const clienteNombre = '@ViewBag.ClienteNombre';
            const clienteRuc = '@ViewBag.ClienteRuc';

            if (clienteId && clienteNombre) {
                const option = new Option(`${clienteNombre} (${clienteRuc})`, clienteId, true, true);
                $('#clienteSelect').append(option).trigger('change');
            }

            // Cuando cambia el cliente, actualizar vehículos
            $('#clienteSelect').on('change', function () {
                const clienteId = $(this).val();
                const vehiculoSelect = $('#vehiculoSelect');
                vehiculoSelect.empty();

                if (clienteId) {
                    fetch(`/Cotizacion/ObtenerVehiculosPorCliente?clienteId=${clienteId}`)
                        .then(r => r.json())
                        .then(data => {
                            vehiculoSelect.append('<option value="">-- Seleccione un vehículo --</option>');
                            data.forEach(v => {
                                vehiculoSelect.append(`<option value="${v.vehiculo_id}">${v.placa} (${v.marca} - ${v.modelo})</option>`);
                            });
                        });
                }
            });
        });

        $(document).ready(function () {

            // Función para inicializar Select2 en repuestos
            function inicializarSelect2Repuestos() {
                $('.repuestoSelect').select2({
                    placeholder: "-- Seleccione un repuesto --",
                    allowClear: true,
                    ajax: {
                        url: '/Cotizacion/BuscarRepuestos',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            return { term: params.term };
                        },
                        processResults: function (data) {
                            return { results: data };
                        }
                    }
                });
            }

            // Inicializar el primero
            inicializarSelect2Repuestos();

            // Preseleccionar repuestos asociados (si existen)
            var repuestosPreseleccionados = @Html.Raw(repuestosPreJson ?? "[]");
            repuestosPreseleccionados.forEach(function (r) {
                var selEl = $('select[name="RepuestosSeleccionados[' + r.index + '].RepuestoId"]');
                if (!selEl.length) return;
                if (selEl.find('option[value="' + r.id + '"]').length === 0) {
                    var option = new Option(r.text, r.id, true, true);
                    selEl.append(option);
                }
                selEl.val(r.id).trigger('change');

                var qtyEl = $('input[name="RepuestosSeleccionados[' + r.index + '].Cantidad"]');
                if (qtyEl.length) {
                    qtyEl.val(r.cantidad || 1);
                }
            });

            // Agregar nueva fila de repuesto
            $(document).on('click', '.agregarRepuesto', function () {
                const container = $('#repuestosContainer');
                const rows = container.find('.repuesto-row');
                const newIndex = rows.length;

                const nuevaFila = rows.first().clone();

                // Actualizar nombres e IDs
                nuevaFila.find('select')
                    .attr('name', `RepuestosSeleccionados[${newIndex}].RepuestoId`)
                    .val(null)
                    .off('select2') // Elimina cualquier instancia previa
                    .removeAttr('data-select2-id')
                    .removeClass('select2-hidden-accessible')
                    .next('.select2').remove();

                nuevaFila.find('input[type="number"]')
                    .attr('name', `RepuestosSeleccionados[${newIndex}].Cantidad`)
                    .val(1);

                container.append(nuevaFila);

                // Re-inicializar Select2 para el nuevo campo
                inicializarSelect2Repuestos();
            });

            // Eliminar fila de repuesto
            $(document).on('click', '.eliminarFila', function () {
                const row = $(this).closest('.repuesto-row');
                if ($('#repuestosContainer .repuesto-row').length > 1) {
                    row.remove();
                }
            });
        });

    </script>
}
