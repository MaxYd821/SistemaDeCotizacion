@model SistemaDeCotizacion.ViewModels.CotizacionVM
@{
    ViewData["Title"] = "Nueva Cotización";
    Layout = "_Layout";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow border-0">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">Registrar Nueva Cotización</h4>
                </div>
                <div class="card-body bg-light">
                    @if (ViewData["mensaje"] != null)
                    {
                        <div class="alert alert-danger text-center">@ViewData["mensaje"]</div>
                    }

                    <form asp-action="Nuevo" method="post">
                        <div class="mb-3">
                            <label>Cliente</label>
                            <select id="clienteSelect" asp-for="ClienteId" class="form-select">
                                <option value="">-- Seleccione un cliente --</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Vehículo</label>
                            <select id="vehiculoSelect" asp-for="VehiculoId" class="form-select">
                                <option value="">-- Seleccione un vehículo --</option>
                            </select>
						</div>

                        <div class="mb-3">
                            <label>Servicios</label>
                            <div id="serviciosContainer">
                                <div class="d-flex align-items-center mb-2 servicio-row">
                                    <select name="ServiciosSeleccionados[0].ServicioId" class="form-select servicioSelect me-2" style="flex: 2">
                                        <option value="">-- Seleccione un servicio --</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-secondary ms-2 agregarServicio">+</button>
                                    <button type="button" class="btn btn-outline-danger ms-2 eliminarFila">🗑</button>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label>Repuestos</label>
                            <div id="repuestosContainer">
                                <div class="d-flex align-items-center mb-2 repuesto-row">
                                    <select name="RepuestosSeleccionados[0].RepuestoId" class="form-select repuestoSelect me-2" style="flex: 2">
                                        <option value="">-- Seleccione un repuesto --</option>
                                    </select>
                                    <input name="RepuestosSeleccionados[0].Cantidad" type="number" class="form-control" style="width:100px" min="1" placeholder="Cant." />
                                    <button type="button" class="btn btn-outline-secondary ms-2 agregarRepuesto">+</button>
                                        <button type="button" class="btn btn-outline-danger ms-2 eliminarFila">🗑</button>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="formaPago" class="form-label">Forma de Pago</label>
                                <input asp-for="formaPago" class="form-control" placeholder="Efectivo, transferencia..." required />
                            </div>
                            <div class="col-md-6">
                                <label asp-for="tiempoEntrega" class="form-label">Tiempo de entrega (días)</label>
                                <input asp-for="tiempoEntrega" type="number" class="form-control" required />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label>Estado</label>
                            <select asp-for="estado_cotizacion" class="form-select">
                                <option value="Pendiente">Pendiente</option>
                            </select>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a asp-action="Mostrar" class="btn btn-outline-dark">Volver</a>
                            <button type="submit" class="btn btn-dark">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>

        $(document).ready(function () {
            function inicializarSelect2Servicios() {
                $('.servicioSelect').select2({
                    placeholder: "-- Seleccione un servicio --",
                    allowClear: true,
                    ajax: {
                        url: '/Cotizacion/BuscarServicios',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            return { term: params.term };
                        },
                        processResults: function (data) {
                            return {
                                results: data
                            };
                        }
                    }
                });
            }

            // Inicializar en la carga inicial
            inicializarSelect2Servicios();

            // Al agregar nueva fila de servicio
            $(document).on('click', '.agregarServicio', function () {
                const container = $('#serviciosContainer');
                const rows = container.find('.servicio-row');
                const newIndex = rows.length;

                const nuevaFila = rows.first().clone();

                // Actualizar nombres e IDs
                nuevaFila.find('select')
                    .attr('name', `ServiciosSeleccionados[${newIndex}].ServicioId`)
                    .val(null)
                    .off('select2') // Evita conflicto
                    .removeAttr('data-select2-id')
                    .removeClass('select2-hidden-accessible')
                    .next('.select2').remove();

                container.append(nuevaFila);

                // Re-inicializar Select2 en la nueva fila
                inicializarSelect2Servicios();
            });

            // Eliminar fila de servicio
            $(document).on('click', '.eliminarFila', function () {
                const row = $(this).closest('.servicio-row');
                if ($('#serviciosContainer .servicio-row').length > 1) {
                    row.remove();
                }
            });
        });

        $(document).ready(function () {
            // Inicializar Select2 para cliente con AJAX
            $('#clienteSelect').select2({
                placeholder: "-- Seleccione un cliente --",
                allowClear: true,
                ajax: {
                    url: '/Cotizacion/BuscarClientes',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return { term: params.term };
                    },
                    processResults: function (data) {
                        return {
                            results: data.map(c => ({
                                id: c.id,
                                text: c.text
                            }))
                        };
                    }
                }
            });

            // Cuando cambia el cliente, actualizar vehículos
            $('#clienteSelect').on('change', function () {
                const clienteId = $(this).val();
                const vehiculoSelect = $('#vehiculoSelect');
                vehiculoSelect.empty();

                if (clienteId) {
                    fetch(`/Cotizacion/ObtenerVehiculosPorCliente?clienteId=${clienteId}`)
                        .then(r => r.json())
                        .then(data => {
                            vehiculoSelect.append('<option value="">-- Seleccione un vehículo --</option>');
                            data.forEach(v => {
                                vehiculoSelect.append(`<option value="${v.vehiculo_id}">${v.placa} (${v.marca} - ${v.modelo})</option>`);
                            });
                        });
                }
            });
        });

        $(document).ready(function () {

            // Función para inicializar Select2 en repuestos
            function inicializarSelect2Repuestos() {
                $('.repuestoSelect').select2({
                    placeholder: "-- Seleccione un repuesto --",
                    allowClear: true,
                    ajax: {
                        url: '/Cotizacion/BuscarRepuestos',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            return { term: params.term };
                        },
                        processResults: function (data) {
                            return { results: data };
                        }
                    }
                });
            }

            // Inicializar el primero
            inicializarSelect2Repuestos();

            // Agregar nueva fila de repuesto
            $(document).on('click', '.agregarRepuesto', function () {
                const container = $('#repuestosContainer');
                const rows = container.find('.repuesto-row');
                const newIndex = rows.length;

                const nuevaFila = rows.first().clone();

                // Actualizar nombres e IDs
                nuevaFila.find('select')
                    .attr('name', `RepuestosSeleccionados[${newIndex}].RepuestoId`)
                    .val(null)
                    .off('select2') // Elimina cualquier instancia previa
                    .removeAttr('data-select2-id')
                    .removeClass('select2-hidden-accessible')
                    .next('.select2').remove();

                nuevaFila.find('input[type="number"]')
                    .attr('name', `RepuestosSeleccionados[${newIndex}].Cantidad`)
                    .val(1);

                container.append(nuevaFila);

                // Re-inicializar Select2 para el nuevo campo
                inicializarSelect2Repuestos();
            });

            // Eliminar fila de repuesto
            $(document).on('click', '.eliminarFila', function () {
                const row = $(this).closest('.repuesto-row');
                if ($('#repuestosContainer .repuesto-row').length > 1) {
                    row.remove();
                }
            });
        });

    </script>
}